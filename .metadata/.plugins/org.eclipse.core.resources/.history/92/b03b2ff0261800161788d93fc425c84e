package com.jiuqi.gov.acc.va.portal.login;

import com.jiuqi.dna.core.situation.MessageListener;
import com.jiuqi.dna.core.situation.MessageTransmitter;
import com.jiuqi.dna.core.situation.Situation;
import com.jiuqi.dna.ui.portal.PageRedirectMessage;
import com.jiuqi.dna.ui.wt.widgets.Composite;
import com.jiuqi.dna.ui.wt.widgets.MessageDialog;
import com.jiuqi.gov.acc.va.portal.message.M_SM_ChangeUnit;
import com.jiuqi.vacomm.utils.ui.WindowUtil;

/**
 * 切换组织机构
 * @author huangrui
 *
 */
public class ChangeLoginUnit {
	
	public static void openLoginUnitPage(final Composite parent, boolean showBook, boolean forLogin) {
		WindowUtil.openDialogWindow(parent, "VA_ChangeUnitPage", 
			showBook ? "工作环境" : forLogin ? "选择登录组织机构" : "切换组织机构", showBook);

		if (forLogin) return;
		
		// 监听选择组织机构结束消息，由选择组织机构对话框发送
		parent.getContext().regMessageListener(M_SM_ChangeUnit.class,
			new MessageListener<M_SM_ChangeUnit>() {
				public void onMessage(Situation context, M_SM_ChangeUnit message,
						MessageTransmitter<M_SM_ChangeUnit> transmitter) {
					try {
						LoginTools.updateLoginInfo(message.getDate(), message.getBookID(), message.getUnitID());
						parent.getContext().bubbleMessage(new PageRedirectMessage(null));
					} catch (Exception e) {
						MessageDialog.alert("工作环境构建失败。", e.getMessage());
					}
				}
			});
	}

}
